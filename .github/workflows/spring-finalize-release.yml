name: Create GH release and Notify Slack

on:
  workflow_call:
    inputs:
      milestone:
        description: 'Milestone title, e.g 3.0.0-M1, 3.1.0-RC1, 3.2.0 etc.'
        required: true
        type: string

    secrets:
      SPRING_RELEASE_CHAT_WEBHOOK_URL:
        required: false
      GH_ACTIONS_REPO_TOKEN:
        required: true

env:
  MILESTONE: ${{ inputs.milestone }}
  GITHUB_TOKEN: ${{ secrets.GH_ACTIONS_REPO_TOKEN }}
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  SPRING_MAIN_BANNERMODE: off

jobs:
  finalize-release:
    runs-on: ubuntu-latest
    steps:

      - uses: actions/checkout@v4
        with:
          show-progress: false

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Tag Release and Next Development Version
        id: tag-release
        run: |
          if test -f pom.xml
          then
            mvn versions:set -DnewVersion=${{ inputs.milestone }} -DgenerateBackupPoms=false -DprocessAllModules=true -B -ntp
          else
            sed -i "s/version=.*/version=${{ inputs.milestone }}/" gradle.properties
          fi
          git config --global user.name 'Spring Builds'
          git config --global user.email 'builds@springframework.org'
          git commit -a -m "[artifactory-release] Release version ${{ inputs.milestone }}"
          git tag "v${{ inputs.milestone }}"
          git push --tags origin
          
          NEXT_VERSION="${{ inputs.milestone }}"
          
          if [[ "$NEXT_VERSION" == *"-"* ]] 
          then
            NEXT_VERSION=${NEXT_VERSION/-*}
          else
            MAJOR=${NEXT_VERSION/.*}
            MINOR_PATCH=${NEXT_VERSION#*.}
            MINOR=${MINOR_PATCH/.*}
            PATCH_HOT_FIX=${MINOR_PATCH#*.}
            PATCH=${PATCH_HOT_FIX/.*}
            PATCH=$((PATCH+1))
            NEXT_VERSION=$MAJOR.$MINOR.$PATCH
          fi
          
          NEXT_VERSION=${NEXT_VERSION}-SNAPSHOT
          
          if test -f pom.xml
          then
            mvn versions:set -DnewVersion=$NEXT_VERSION -DgenerateBackupPoms=false -DprocessAllModules=true -B -ntp
          else
            sed -i "s/version=.*/version=$NEXT_VERSION/" gradle.properties
          fi
          
          git commit -a -m "[artifactory-release] Next development version"
          git push origin
          
          echo nextVersion=$NEXT_VERSION >> $GITHUB_OUTPUT

      - name: Changelog Config File
        run: |
          repositoryTeam=$(gh api repos/$GITHUB_REPOSITORY/collaborators --jq 'map(select(.role_name == "admin") | .login) | tostring')
          repositoryTeam=$(sed 's/"//g' <<< ${repositoryTeam:1:-1})
          repositoryVisibility=$(gh repo view --json visibility --jq .[])
          repositoryVisibility=$([[ $repositoryVisibility = 'PUBLIC' ]] && echo 'true' || echo 'false')
          
          echo "changelog.contributors.exclude.names=$repositoryTeam" > changelog.properties
          echo "changelog.issues.generate-links=$repositoryVisibility" >> changelog.properties

      - name: Generate Changelog
        uses: spring-io/github-changelog-generator@v0.0.11
        with:
          milestone: ${{ env.MILESTONE }}
          token: ${{ env.GITHUB_TOKEN }}
          config-file: changelog.properties

      - name: GitHub Release
        run: |
          RELEASE_URL=$(gh release create v${{ env.MILESTONE }} -F changelog.md ${{ (contains(env.MILESTONE, '-M') || contains(env.MILESTONE, '-RC')) && '--prerelease' || '' }})
          echo "::notice title=Release Page::$RELEASE_URL"

      - name: Close Milestone
        run: |
          MILESTONE_ID=$(gh api repos/$GITHUB_REPOSITORY/milestones --jq '.[] | select(.title == env.MILESTONE) | .number')
          if [ $MILESTONE_ID ]; then
            gh api -X PATCH repos/$GITHUB_REPOSITORY/milestones/$MILESTONE_ID -f state='closed' --silent
          fi

      - name: Announce Release in Chat
        if: env.CHAT_WEBHOOK_URL
        run: |
          curl -X POST '${{ env.CHAT_WEBHOOK_URL }}' -H 'Content-Type: application/json' -d '{ text: "${{ github.event.repository.name }}-announcing `${{ env.MILESTONE }}`"}'
        env:
          CHAT_WEBHOOK_URL: ${{ secrets.SPRING_RELEASE_CHAT_WEBHOOK_URL }}

#      - name: Announce Release on Slack
#        uses: slackapi/slack-github-action@v1.26.0
#        if: env.SLACK_WEBHOOK_URL
#        env:
#          SLACK_WEBHOOK_URL: ${{ secrets.SPRING_RELEASE_SLACK_WEBHOOK_URL }}
#          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
#        with:
#          payload: |
#            {
#              "text": "${{ github.event.repository.name }}-announcing `${{ env.MILESTONE }}`"
#            }